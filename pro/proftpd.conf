# ProFTPD Configuration for SFTP-only access
ServerName "ProFTPD SFTP Server"
ServerType standalone
DefaultServer on
Port 22
UseIPv6 off

# Disable regular FTP, enable SFTP only
SFTPEngine on
SFTPLog /var/log/proftpd/sftp.log

# SSH host keys
SFTPHostKey /etc/proftpd/keys/sftp_rsa_host_key
SFTPHostKey /etc/proftpd/keys/sftp_ecdsa_host_key
SFTPHostKey /etc/proftpd/keys/sftp_ed25519_host_key

# Public key authentication only (no passwords)
SFTPAuthMethods publickey
SFTPAuthorizedUserKeys file:/etc/proftpd/authorized_keys/%u

# Disable regular FTP
<IfModule mod_auth_pam.c>
  AuthPAM off
</IfModule>

# User and group settings
User proftpd
Group proftpd

# Disable shell requirement
RequireValidShell off

# Chroot users to their home directory (similar to your SSH chroot)
DefaultRoot ~

# Only allow the sftpuser (equivalent to AllowUsers)
<Limit LOGIN>
  AllowUser sftpuser
  DenyAll
</Limit>

# Configure the uploads directory behavior
<Directory /home/sftpuser>
  <Limit WRITE>
    DenyAll
  </Limit>
</Directory>

<Directory /home/sftpuser/uploads>
  # Allow file operations in uploads directory
  <Limit STOR DELE RNFR RNTO MKD RMD>
    AllowUser sftpuser
  </Limit>
  
  # Enable hidden stores for atomic uploads
  # Files will be created as .in.filename during upload
  HiddenStores on
  
  # Set umask for uploaded files
  Umask 022
  
  # Allow overwrite of existing files
  AllowOverwrite yes
</Directory>

# SFTP-specific settings
<IfModule mod_sftp.c>
  # Restrict to SFTP protocol only
  SFTPOptions IgnoreSFTPSetstat IgnoreSFTPSetOwners
  
  # Set the default directory when users connect (like ForceCommand internal-sftp -d /uploads)
  <Directory /home/sftpuser>
    SFTPDefaultDir /uploads
  </Directory>
</IfModule>

# Logging
SystemLog /var/log/proftpd/proftpd.log
TransferLog /var/log/proftpd/xferlog

# Security settings (equivalent to your SSH restrictions)
<Global>
  # No TCP forwarding equivalent (SFTP doesn't have this concept)
  # No X11 forwarding equivalent (SFTP doesn't have this concept)
  
  # Prevent changing to parent directories (chroot-like behavior)
  <Limit CDUP>
    DenyAll
  </Limit>
</Global>